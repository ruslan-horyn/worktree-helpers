#compdef wt
# shellcheck shell=bash disable=SC2148,SC2034,SC2207,SC2296,SC2206,SC2154,SC2128
# Zsh completion for wt (worktree-helpers)
# Note: This file uses zsh-specific syntax (compdef, _describe, ${(f)...}).
# Shellcheck warnings for zsh-only features are suppressed above.

_wt() {
  local -a commands flags
  local context state

  commands=(
    '-n:Create worktree from main'
    '--new:Create worktree from main'
    '-s:Switch worktree'
    '--switch:Switch worktree'
    '-r:Remove worktree and branch'
    '--remove:Remove worktree and branch'
    '-o:Open existing branch as worktree'
    '--open:Open existing branch as worktree'
    '-l:List worktrees'
    '--list:List worktrees'
    '-c:Clear old worktrees'
    '--clear:Clear old worktrees'
    '-L:Lock worktree'
    '--lock:Lock worktree'
    '-U:Unlock worktree'
    '--unlock:Unlock worktree'
    '--init:Initialize config'
    '--log:Show commits vs main'
    '--rename:Rename current worktree branch'
    '--update:Update worktree-helpers to latest version'
    '--uninstall:Uninstall worktree-helpers'
    '-v:Show version'
    '--version:Show version'
    '-h:Show help'
    '--help:Show help'
  )

  flags=(
    '-f:Force operation'
    '--force:Force operation'
    '-d:Use dev branch as base'
    '--dev:Use dev branch as base'
    '-b:Use custom base branch'
    '--from:Use custom base branch'
    '--dev-only:Filter to dev worktrees only'
    '--main-only:Filter to main worktrees only'
    '--reflog:Show reflog'
    '--since:Filter by date'
    '--author:Filter by author'
    '--merged:Clear merged worktrees only'
    '--pattern:Clear worktrees matching pattern'
    '--dry-run:Show what would be cleared'
    '--check:Check for updates without installing'
  )

  # Determine what we're completing based on the previous words.
  # expect_arg=1 means the next word is a value argument â€” consume it and reset.
  local prev_action="" expect_arg=0
  local i
  for ((i = 1; i < CURRENT; i++)); do
    if (( expect_arg )); then
      expect_arg=0
      prev_action=""
      continue
    fi
    case "${words[i]}" in
      -s|--switch|-r|--remove|-L|--lock|-U|--unlock)
        prev_action="worktree_branch"; expect_arg=1 ;;
      -o|--open)
        prev_action="git_branch"; expect_arg=1 ;;
      -b|--from)
        prev_action="hint_ref"; expect_arg=1 ;;
      --log)
        prev_action="local_branch"; expect_arg=1 ;;
      -n|--new)
        prev_action="hint_branch"; expect_arg=1 ;;
      --rename)
        prev_action="hint_new_branch"; expect_arg=1 ;;
      -c|--clear)
        prev_action="clear_context" ;;
      --pattern)
        prev_action="hint_pattern"; expect_arg=1 ;;
      --since)
        prev_action="hint_date"; expect_arg=1 ;;
      --author)
        prev_action="hint_author"; expect_arg=1 ;;
    esac
  done

  # Check if the immediately previous word expects a value argument
  # (overrides the action-based context for the next token)
  case "${words[CURRENT-1]}" in
    -s|--switch|-r|--remove|-L|--lock|-U|--unlock)
      prev_action="worktree_branch" ;;
    -o|--open)
      prev_action="git_branch" ;;
    -b|--from)
      prev_action="hint_ref" ;;
    --log)
      prev_action="local_branch" ;;
    -n|--new)
      prev_action="hint_branch" ;;
    --rename)
      prev_action="hint_new_branch" ;;
    --pattern)
      prev_action="hint_pattern" ;;
    --since)
      prev_action="hint_date" ;;
    --author)
      prev_action="hint_author" ;;
  esac

  case "$prev_action" in
    worktree_branch)
      local -a wt_branches
      wt_branches=(${(f)"$(git worktree list --porcelain 2>/dev/null | \
        sed -n 's/^branch refs\/heads\///p')"})
      compadd -V unsorted -a wt_branches
      ;;
    git_branch)
      local -a branches
      branches=(${(f)"$(git for-each-ref --format='%(refname:short)' \
        refs/heads refs/remotes/origin 2>/dev/null | \
        sed 's|^origin/||' | sort -u)"})
      compadd -V unsorted -a branches
      ;;
    local_branch)
      local -a branches
      branches=(${(f)"$(git for-each-ref --format='%(refname:short)' \
        refs/heads 2>/dev/null)"})
      compadd -V unsorted -a branches
      ;;
    clear_context)
      _describe 'flag' flags
      ;;
    hint_branch)
      ;;
    hint_ref)
      local -a hint; hint=('<ref>:branch, tag, or commit to base from')
      _describe -t hints 'ref' hint
      ;;
    hint_new_branch)
      local -a hint; hint=('<new-branch>:new branch name to rename to')
      _describe -t hints 'hint' hint
      ;;
    hint_pattern)
      local -a pats
      pats=(
        'feature/*:clear all feature worktrees'
        'story-*:clear all story worktrees'
        'fix/*:clear all fix worktrees'
        'NO_TASK:clear worktrees without a task association'
      )
      _describe -t patterns 'Pattern' pats
      ;;
    hint_date)
      local -a pats
      pats=(
        '2 weeks ago:commits from last 2 weeks'
        'yesterday:commits from yesterday'
        '1 month ago:commits from last month'
      )
      _describe -t dates 'Date' pats
      ;;
    hint_author)
      local -a hint; hint=('<author>:author name or email')
      _describe -t hints 'hint' hint
      ;;
    *)
      local -a all_options
      all_options=($commands $flags)
      _describe 'option' all_options
      ;;
  esac
}

_wt "$@"
